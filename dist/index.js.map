{"version":3,"file":"index.js","sources":["../src/ast-transform.ts","../src/index.ts"],"sourcesContent":["import type {\n  ASTPluginBuilder,\n  ASTPluginEnvironment,\n  ASTv1,\n} from '@glimmer/syntax';\nimport type { WithJSUtils } from 'babel-plugin-ember-template-compilation';\nimport crypto from 'node:crypto';\n\ntype Env = WithJSUtils<ASTPluginEnvironment> & {\n  filename: string;\n  contents: string;\n  strict?: boolean;\n  locals?: string[];\n};\n\nfunction uniqueIdentifier(filename: string): string {\n  let hash = crypto.createHash('sha1');\n  hash.update(filename);\n  return hash.digest('hex').slice(0, 10);\n}\n\nconst scopedCSSTransform: ASTPluginBuilder<Env> = (env) => {\n  let dataAttribute = `data-scopedcss-${uniqueIdentifier(env.filename)}`;\n\n  let {\n    syntax: { builders },\n    meta: { jsutils },\n  } = env;\n\n  return {\n    name: 'glimmer-scoped-css',\n\n    visitor: {\n      ElementNode(node) {\n        if (node.tag === 'style') {\n          // TODO: hard coding the loader chain means we ignore the other\n          // prevailing rules (and we're even assuming these loaders are\n          // available)\n          let encodedCssFilePath = btoa(textContent(node));\n\n          jsutils.importForSideEffect(\n            `style-loader!css-loader!glimmer-scoped-css/virtual-loader?file=${encodedCssFilePath}&selector=${dataAttribute}!`\n          );\n          return null;\n        } else {\n          if (node.tag.startsWith(':')) {\n            return node;\n          } else {\n            node.attributes.push(\n              builders.attr(dataAttribute, builders.text(''))\n            );\n          }\n        }\n      },\n    },\n  };\n};\n\nexport default scopedCSSTransform;\n\nfunction textContent(node: ASTv1.ElementNode): string {\n  let textChildren = node.children.filter(\n    (c) => c.type === 'TextNode'\n  ) as ASTv1.TextNode[];\n  return textChildren.map((c) => c.chars).join('');\n}\n","import plugin from './ast-transform';\n\nexport function installScopedCSS(registry: any) {\n  registry.add('htmlbars-ast-plugin', buildASTPlugin());\n}\n\nexport function buildASTPlugin() {\n  return {\n    name: 'glimmer-scoped-css',\n    plugin,\n    baseDir: function () {\n      return __dirname;\n    },\n    parallelBabel: {\n      requireFile: __filename,\n      buildUsing: 'buildASTPlugin',\n      params: {},\n    },\n  };\n}\n"],"names":["uniqueIdentifier","filename","hash","crypto","createHash","update","digest","slice","scopedCSSTransform","env","dataAttribute","syntax","builders","meta","jsutils","name","visitor","ElementNode","node","tag","encodedCssFilePath","btoa","textContent","importForSideEffect","startsWith","attributes","push","attr","text","textChildren","children","filter","c","type","map","chars","join","installScopedCSS","registry","add","buildASTPlugin","plugin","baseDir","__dirname","parallelBabel","requireFile","__filename","buildUsing","params"],"mappings":";;;;;;;;;;AAeA,SAASA,gBAAgBA,CAACC,QAAgB,EAAU;AAClD,EAAA,IAAIC,IAAI,GAAGC,0BAAM,CAACC,UAAU,CAAC,MAAM,CAAC,CAAA;AACpCF,EAAAA,IAAI,CAACG,MAAM,CAACJ,QAAQ,CAAC,CAAA;AACrB,EAAA,OAAOC,IAAI,CAACI,MAAM,CAAC,KAAK,CAAC,CAACC,KAAK,CAAC,CAAC,EAAE,EAAE,CAAC,CAAA;AACxC,CAAA;AAEA,MAAMC,kBAAyC,GAAIC,GAAG,IAAK;EACzD,IAAIC,aAAa,GAAI,CAAiBV,eAAAA,EAAAA,gBAAgB,CAACS,GAAG,CAACR,QAAQ,CAAE,CAAC,CAAA,CAAA;EAEtE,IAAI;AACFU,IAAAA,MAAM,EAAE;AAAEC,MAAAA,QAAAA;KAAU;AACpBC,IAAAA,IAAI,EAAE;AAAEC,MAAAA,OAAAA;AAAQ,KAAA;AAClB,GAAC,GAAGL,GAAG,CAAA;EAEP,OAAO;AACLM,IAAAA,IAAI,EAAE,oBAAoB;AAE1BC,IAAAA,OAAO,EAAE;MACPC,WAAWA,CAACC,IAAI,EAAE;AAChB,QAAA,IAAIA,IAAI,CAACC,GAAG,KAAK,OAAO,EAAE;AACxB;AACA;AACA;UACA,IAAIC,kBAAkB,GAAGC,IAAI,CAACC,WAAW,CAACJ,IAAI,CAAC,CAAC,CAAA;UAEhDJ,OAAO,CAACS,mBAAmB,CACxB,CAAA,+DAAA,EAAiEH,kBAAmB,CAAYV,UAAAA,EAAAA,aAAc,GAAE,CAClH,CAAA;AACD,UAAA,OAAO,IAAI,CAAA;AACb,SAAC,MAAM;UACL,IAAIQ,IAAI,CAACC,GAAG,CAACK,UAAU,CAAC,GAAG,CAAC,EAAE;AAC5B,YAAA,OAAON,IAAI,CAAA;AACb,WAAC,MAAM;AACLA,YAAAA,IAAI,CAACO,UAAU,CAACC,IAAI,CAClBd,QAAQ,CAACe,IAAI,CAACjB,aAAa,EAAEE,QAAQ,CAACgB,IAAI,CAAC,EAAE,CAAC,CAAC,CAChD,CAAA;AACH,WAAA;AACF,SAAA;AACF,OAAA;AACF,KAAA;GACD,CAAA;AACH,CAAC,CAAA;AAID,SAASN,WAAWA,CAACJ,IAAuB,EAAU;AACpD,EAAA,IAAIW,YAAY,GAAGX,IAAI,CAACY,QAAQ,CAACC,MAAM,CACpCC,CAAC,IAAKA,CAAC,CAACC,IAAI,KAAK,UAAU,CACT,CAAA;AACrB,EAAA,OAAOJ,YAAY,CAACK,GAAG,CAAEF,CAAC,IAAKA,CAAC,CAACG,KAAK,CAAC,CAACC,IAAI,CAAC,EAAE,CAAC,CAAA;AAClD;;AC/DO,SAASC,gBAAgBA,CAACC,QAAa,EAAE;AAC9CA,EAAAA,QAAQ,CAACC,GAAG,CAAC,qBAAqB,EAAEC,cAAc,EAAE,CAAC,CAAA;AACvD,CAAA;AAEO,SAASA,cAAcA,GAAG;EAC/B,OAAO;AACLzB,IAAAA,IAAI,EAAE,oBAAoB;YAC1B0B,kBAAM;IACNC,OAAO,EAAE,YAAY;AACnB,MAAA,OAAOC,SAAS,CAAA;KACjB;AACDC,IAAAA,aAAa,EAAE;AACbC,MAAAA,WAAW,EAAEC,UAAU;AACvBC,MAAAA,UAAU,EAAE,gBAAgB;AAC5BC,MAAAA,MAAM,EAAE,EAAC;AACX,KAAA;GACD,CAAA;AACH;;;;;"}